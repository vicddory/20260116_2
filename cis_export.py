import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import platform

# -----------------------------------------------------------------------------
# 1. í•œê¸€ í°íŠ¸ ì„¤ì • (ë§¥, ìœˆë„ìš°, ë¦¬ëˆ…ìŠ¤ í˜¸í™˜)
# -----------------------------------------------------------------------------
# ê·¸ë˜í”„ì— í•œê¸€ì„ í‘œì‹œí•˜ê¸° ìœ„í•´ ìš´ì˜ì²´ì œ(OS)ì— ë§ëŠ” í°íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
if platform.system() == 'Darwin': # ë§¥(Mac)
    plt.rc('font', family='AppleGothic')
elif platform.system() == 'Windows': # ìœˆë„ìš°(Windows)
    plt.rc('font', family='Malgun Gothic')
else: # ë¦¬ëˆ…ìŠ¤(Linux) ë˜ëŠ” Streamlit Cloud ë“±
    # ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œëŠ” í•œê¸€ í°íŠ¸ê°€ ì—†ì„ ìˆ˜ ìˆì–´ ê²½ê³  ì²˜ë¦¬ë¥¼ í•˜ê±°ë‚˜ ë‚˜ëˆ”ê³ ë”• ë“±ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
    # ì¼ë‹¨ ê¸°ë³¸ í°íŠ¸ë¡œ ì„¤ì •í•˜ë˜, ê¹¨ì§ˆ ê²½ìš° 'nanum-gothic' ì„¤ì¹˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    try:
        plt.rc('font', family='NanumGothic')
    except:
        plt.rc('font', family='DejaVu Sans')

# ë§ˆì´ë„ˆìŠ¤ ê¸°í˜¸(-)ê°€ ê¹¨ì§€ëŠ” í˜„ìƒ ë°©ì§€
plt.rcParams['axes.unicode_minus'] = False


# -----------------------------------------------------------------------------
# 2. ì›¹í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="CIS ì§€ì—­ë³¸ë¶€ ìœ ì‚¬ë„ ë¶„ì„",
    page_icon="ğŸŒ",
    layout="wide"
)

st.title("ğŸŒ CIS ì§€ì—­ë³¸ë¶€ êµ­ê°€ ê°„ ìœ ì‚¬ë„ ë¶„ì„")
st.markdown("ê³µê³µë°ì´í„°í¬í„¸ì˜ **'CISì§€ì—­ë³¸ë¶€'** ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ êµ­ê°€ë³„ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.")


# -----------------------------------------------------------------------------
# 3. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# -----------------------------------------------------------------------------
# @st.cache_dataëŠ” ë°ì´í„°ë¥¼ ë§¤ë²ˆ ìƒˆë¡œ ì½ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì— ì €ì¥í•´ë‘ì–´ ì†ë„ë¥¼ ë†’ì…ë‹ˆë‹¤.
@st.cache_data
def load_data():
    file_path = "CISì§€ì—­ë³¸ë¶€.csv" # íŒŒì¼ ê²½ë¡œ (ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•¨)
    
    # ê³µê³µë°ì´í„°ëŠ” ë³´í†µ 'cp949' ì¸ì½”ë”©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    # ë§Œì•½ ì—ëŸ¬ê°€ ë‚˜ë©´ ìë™ìœ¼ë¡œ 'utf-8'ë¡œ ë‹¤ì‹œ ì‹œë„í•˜ë„ë¡ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.
    try:
        df = pd.read_csv(file_path, encoding='cp949')
    except UnicodeDecodeError:
        df = pd.read_csv(file_path, encoding='utf-8')
    return df

try:
    df = load_data()
    st.success("ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")
    
    # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ë°ì´í„°í”„ë ˆì„ì´ ì—´ë¦½ë‹ˆë‹¤)
    if st.checkbox("ì›ë³¸ ë°ì´í„° ë³´ê¸°"):
        st.dataframe(df)

except FileNotFoundError:
    st.error("CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ëª…ê³¼ ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop() # íŒŒì¼ì´ ì—†ìœ¼ë©´ ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  ë©ˆì¶¤


# -----------------------------------------------------------------------------
# 4. ë¶„ì„ 1: ì „ì²´ êµ­ê°€ ìœ ì‚¬ë„ íˆíŠ¸ë§µ (Heatmap)
# -----------------------------------------------------------------------------
st.header("1. êµ­ê°€ ê°„ ìœ ì‚¬ë„ ì „ì²´ ì§€ë„ (Heatmap)")
st.info("ìƒ‰ì´ ì§„í• ìˆ˜ë¡(ë˜ëŠ” ë°ì„ìˆ˜ë¡) ë‘ êµ­ê°€ ê°„ì˜ ìœ ì‚¬ë„ê°€ ë†’ìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.")

# íˆíŠ¸ë§µì„ ê·¸ë¦¬ë ¤ë©´ ë°ì´í„°ë¥¼ 'í–‰ë ¬(Matrix)' í˜•íƒœë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.
# í–‰(index): êµ­ê°€ëª…1, ì—´(columns): êµ­ê°€ëª…2, ê°’(values): ì½”ì‚¬ì¸ ìœ ì‚¬ë„
df_pivot = df.pivot(index="êµ­ê°€ëª…1", columns="êµ­ê°€ëª…2", values="ì½”ì‚¬ì¸ ìœ ì‚¬ë„")

# ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
fig1, ax1 = plt.subplots(figsize=(12, 10)) # ë„í™”ì§€ í¬ê¸° ì„¤ì •

# seabornì˜ heatmap í•¨ìˆ˜ ì‚¬ìš©
sns.heatmap(data=df_pivot, 
            annot=True,      # ì¹¸ ì•ˆì— ìˆ«ì í‘œì‹œ ì—¬ë¶€
            fmt=".2f",       # ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ
            cmap="Blues",    # ìƒ‰ìƒ í…Œë§ˆ (íŒŒë€ìƒ‰ ê³„ì—´)
            ax=ax1)          # ìœ„ì—ì„œ ë§Œë“  ax1 ì˜ì—­ì— ê·¸ë¦¼

ax1.set_title("CIS êµ­ê°€ ê°„ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ íˆíŠ¸ë§µ")
st.pyplot(fig1)


# -----------------------------------------------------------------------------
# 5. ë¶„ì„ 2: íŠ¹ì • êµ­ê°€ ì¤‘ì‹¬ ë¹„êµ (Bar Chart)
# -----------------------------------------------------------------------------
st.header("2. íŠ¹ì • êµ­ê°€ ì¤‘ì‹¬ ìƒì„¸ ë¶„ì„")

# ë¶„ì„í•  ê¸°ì¤€ êµ­ê°€ ì„ íƒí•˜ê¸° (ì¤‘ë³µ ì œê±°ëœ êµ­ê°€ ëª©ë¡ ì‚¬ìš©)
country_list = df['êµ­ê°€ëª…1'].unique()
selected_country = st.selectbox("ê¸°ì¤€ì´ ë  êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”:", country_list)

if selected_country:
    # ì„ íƒí•œ êµ­ê°€ì˜ ë°ì´í„°ë§Œ í•„í„°ë§ (ìì‹ ê³¼ì˜ ë¹„êµì¸ 1.0ì€ ì œì™¸ ê°€ëŠ¥)
    # ì—¬ê¸°ì„œëŠ” ìì‹ (ìœ ì‚¬ë„ 1.0)ì„ í¬í•¨í•˜ì—¬ ë¹„êµí•©ë‹ˆë‹¤.
    filtered_df = df[df['êµ­ê°€ëª…1'] == selected_country]
    
    # ìœ ì‚¬ë„ê°€ ë†’ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
    sorted_df = filtered_df.sort_values(by="ì½”ì‚¬ì¸ ìœ ì‚¬ë„", ascending=False)
    
    # ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    fig2, ax2 = plt.subplots(figsize=(10, 6))
    
    # xì¶•: ìœ ì‚¬ë„ ê°’, yì¶•: ìƒëŒ€ êµ­ê°€ëª…
    sns.barplot(x="ì½”ì‚¬ì¸ ìœ ì‚¬ë„", y="êµ­ê°€ëª…2", data=sorted_df, palette="viridis", ax=ax2)
    
    # ê·¸ë˜í”„ ê¾¸ë¯¸ê¸°
    ax2.set_title(f"[{selected_country}] ì™€(ê³¼) ë‹¤ë¥¸ êµ­ê°€ë“¤ì˜ ìœ ì‚¬ë„ ìˆœìœ„")
    ax2.set_xlabel("ì½”ì‚¬ì¸ ìœ ì‚¬ë„")
    ax2.set_ylabel("ë¹„êµ êµ­ê°€")
    
    # ë§‰ëŒ€ ëì— ìˆ˜ì¹˜ í‘œì‹œí•˜ê¸° (ì¡°ê¸ˆ ë” ê³ ê¸‰ ê¸°ëŠ¥)
    for p in ax2.patches:
        ax2.annotate(f'{p.get_width():.2f}', 
                     (p.get_width(), p.get_y() + p.get_height() / 2), 
                     ha='left', va='center', xytext=(5, 0), textcoords='offset points')

    st.pyplot(fig2)